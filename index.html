<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FaDe SCOUT v.2.0</title>
  <meta name="description" content="Gestione giocatori con schede, foto, filtri avanzati, import Excel e stampa. Con sincronizzazione cloud." />
  <link rel="icon" href="Binoculars-PNG-Picture copia.png" />
  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{--g1:#1b5e20;--g2:#66bb6a;--ink:#1b5e20}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:linear-gradient(135deg,var(--g1),var(--g2));color:#222}
    header{background:rgba(255,255,255,.9);padding:10px 20px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:5}
    header img{width:50px;height:50px}
    header h1{margin:0;font-size:32px;color:var(--ink);font-weight:800;letter-spacing:.2px}
    .cloud-badge{margin-left:auto;display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .on{background:#2e7d32}.off{background:#b71c1c}
    main{padding:20px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px}
    .controls input,.controls select,.controls button{padding:8px 12px;border-radius:10px;border:1px solid #bcd9bd;background:#fff}
    .fab{padding:10px 14px;border:none;border-radius:10px;background:#2e7d32;color:#fff;cursor:pointer}
    .fab.secondary{background:#fff;color:#1b5e20;border:1px solid #a7d3a9}
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;min-width:900px}
    th,td{padding:10px;border:1px solid #e3f0e4;text-align:left}
    th{background:#c8e6c9}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
    .modal.open{display:flex}
    .sheet{background:#fff;padding:20px;border-radius:12px;width:min(920px,95vw)}
    .sheet .grid{display:grid;grid-template-columns:220px 1fr;gap:16px}
    .sheet input,.sheet select,.sheet textarea{width:100%;margin-bottom:10px;padding:8px;border-radius:8px;border:1px solid #ccc;background:#fff}
    .avatar{width:160px;height:160px;border-radius:12px;object-fit:cover;background:#e8f5e9;border:2px solid #c8e6c9}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    @media (max-width:640px){
      header h1{font-size:24px}
      main{padding:12px}
      .controls{gap:8px}
      .controls>*{flex:1 1 100%}
      .sheet{width:100vw;height:100vh;border-radius:0;overflow:auto;padding:16px}
      .sheet .grid{grid-template-columns:1fr}
      .avatar{width:140px;height:140px}
      .fab{min-height:44px}
      table{min-width:720px}
    }
    @media print{ header,.controls,.modal,.toolbar{display:none!important} body{background:#fff} }
  </style>
</head>
<body>
  <header>
    <img src="Binoculars-PNG-Picture copia.png" alt="logo" />
    <h1>FaDe SCOUT v.2.0</h1>
    <div class="cloud-badge">
      <div id="cloud-dot" class="dot off" title="Cloud"></div>
      <span id="cloud-text">Cloud: disconnesso</span>
      <button class="fab secondary" onclick="openCloudSettings()">Cloud</button>
    </div>
  </header>

  <main>
    <div class="controls">
      <input id="f-name" placeholder="Cognome o Nome" />
      <input id="f-team" placeholder="Squadra" />
      <select id="f-role"><option value="">Ruolo</option><option>Portiere</option><option>Difensore</option><option>Centrocampista</option><option>Attaccante</option></select>
      <select id="f-category"><option value="">Categoria</option><option>SERIE D</option><option>ECCELLENZA</option><option>PROMOZIONE</option><option>PRIMA CATEGORIA</option><option>SECONDA CATEGORIA</option><option>TERZA CATEGORIA</option><option>JUNIORES</option><option>ALLIEVI</option></select>
      <select id="f-module"><option value="">Modulo</option><option>4-3-3</option><option>4-2-3-1</option><option>4-4-2</option><option>3-5-2</option><option>3-4-3</option></select>
      <select id="f-foot"><option value="">Piede</option><option>Destro</option><option>Sinistro</option><option>Ambidestro</option></select>
      <button onclick="applyFilters()">Filtra</button>
      <button class="fab secondary" onclick="resetFilters()">Reset</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Foto</th>
            <th>Cognome</th>
            <th>Nome</th>
            <th>Ruolo</th>
            <th>Categoria</th>
            <th>Modulo</th>
            <th>Squadra</th>
            <th>Piede</th>
            <th>Anno</th>
            <th>Note</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="toolbar">
      <button class="fab" onclick="openModal()">+ Aggiungi giocatore</button>
      <button class="fab" onclick="triggerExcel()">Importa da Excel</button>
      <input id="excel-file" type="file" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" style="display:none" />
      <button class="fab secondary" onclick="window.print()">Stampa / PDF</button>
    </div>
  </main>

  <!-- Modale scheda giocatore -->
  <div class="modal" id="modal">
    <div class="sheet">
      <h2>Scheda giocatore</h2>
      <div class="grid">
        <div>
          <img id="p-photo" class="avatar" alt="foto" />
          <input type="file" id="p-photo-file" accept="image/*" capture="environment" />
        </div>
        <div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <input id="p-lastname" placeholder="Cognome" />
            <input id="p-firstname" placeholder="Nome" />
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <select id="p-role"><option>Portiere</option><option>Difensore</option><option>Centrocampista</option><option>Attaccante</option></select>
            <select id="p-category"><option></option><option>SERIE D</option><option>ECCELLENZA</option><option>PROMOZIONE</option><option>PRIMA CATEGORIA</option><option>SECONDA CATEGORIA</option><option>TERZA CATEGORIA</option><option>JUNIORES</option><option>ALLIEVI</option></select>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <input id="p-module" placeholder="Modulo (es. 4-3-3)" />
            <input id="p-team" placeholder="Squadra" />
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <select id="p-foot"><option></option><option>Destro</option><option>Sinistro</option><option>Ambidestro</option></select>
            <input id="p-year" type="number" min="1900" max="2099" placeholder="Anno" />
          </div>
          <textarea id="p-notes" placeholder="Note"></textarea>
          <div style="display:flex; gap:10px; justify-content:flex-end">
            <button class="fab secondary" onclick="closeModal()">Chiudi</button>
            <button class="fab" onclick="savePlayer()">Salva</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale impostazioni Cloud -->
  <div class="modal" id="cloud-modal">
    <div class="sheet" style="max-width:720px">
      <h2>Connessione Cloud (Firebase)</h2>
      <p style="margin:6px 0 12px">1) Crea un progetto su <b>Firebase</b> → Web App → copia il blocco <i>config</i>.<br>2) Incollalo qui sotto (JSON o oggetto JS). 3) Premi <b>Connetti</b>.</p>
      <textarea id="firebase-config-input" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","appId":"..."}' style="width:100%;height:160px"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button class="fab secondary" onclick="closeCloudSettings()">Annulla</button>
        <button class="fab" onclick="connectFirebaseFromUI()">Connetti</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Stato locale (fallback) =====
    let players = []; // array locale usato se Cloud è off
    let currentIndex = null;
    const tbody = document.getElementById('tbody');

    // ===== Stato Cloud =====
    let fbApp = null, auth = null, db = null, storage = null, uid = null, unsub = null;
    const cloud = { isOn:false, players:[] };
    let lastPhotoFile = null; // ultimo file foto selezionato

    function setCloudStatus(on){
      const dot = document.getElementById('cloud-dot');
      const txt = document.getElementById('cloud-text');
      if(on){ dot.classList.remove('off'); dot.classList.add('on'); txt.textContent = 'Cloud: connesso'; }
      else  { dot.classList.remove('on');  dot.classList.add('off'); txt.textContent = 'Cloud: disconnesso'; }
    }

    function normalizeCategory(cat){
      if(!cat) return '';
      const first=(String(cat).trim().split(/\s+/)[0]||'').toUpperCase();
      if(first.startsWith('ECC')) return 'ECC';
      if(first.startsWith('PRO')) return 'PRO';
      if(first.startsWith('PRIMA')) return 'PRIMA';
      if(first.startsWith('SECONDA')) return 'SECONDA';
      if(first.startsWith('TERZA')) return 'TERZA';
      if(first.startsWith('JUN')) return 'JUNIORES';
      if(first.startsWith('ALL')) return 'ALLIEVI';
      if(first==='SERIE') return 'SERIE D';
      return first;
    }

    function render(list = (cloud.isOn?cloud.players:players)){
      tbody.innerHTML='';
      list.forEach((p,i)=>{
        const tr=document.createElement('tr');
        const photo=(p.photoUrl||p.photo)||'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="100%" height="100%" fill="#e8f5e9"/></svg>');
        tr.innerHTML=`
          <td><img src="${photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #c8e6c9"/></td>
          <td><strong>${p.lastName||''}</strong></td>
          <td>${p.firstName||''}</td>
          <td>${p.role||''}</td>
          <td>${normalizeCategory(p.category)||''}</td>
          <td>${p.module||''}</td>
          <td>${p.team||''}</td>
          <td>${p.foot||''}</td>
          <td>${p.year||''}</td>
          <td>${p.notes||''}</td>
          <td><button class="fab secondary" onclick="editPlayer(${i})">Apri</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function openModal(p=null){
      document.getElementById('modal').classList.add('open');
      if(p){
        document.getElementById('p-firstname').value=p.firstName||'';
        document.getElementById('p-lastname').value=p.lastName||'';
        document.getElementById('p-role').value=p.role||'Centrocampista';
        document.getElementById('p-category').value=p.category||'';
        document.getElementById('p-module').value=p.module||'';
        document.getElementById('p-team').value=p.team||'';
        document.getElementById('p-foot').value=p.foot||'';
        document.getElementById('p-year').value=p.year||'';
        document.getElementById('p-notes').value=p.notes||'';
        document.getElementById('p-photo').src=(p.photoUrl||p.photo)||'';
        currentIndex = iFromList(p);
      } else {
        document.querySelectorAll('#modal input, #modal select, #modal textarea').forEach(e=>e.value='');
        document.getElementById('p-photo').src='';
        currentIndex=null;
      }
    }
    function closeModal(){ document.getElementById('modal').classList.remove('open'); }
    function iFromList(p){ return cloud.isOn ? cloud.players.findIndex(x=>x.__id===p.__id) : players.indexOf(p); }

    // Gestione foto (preview immediata)
    document.addEventListener('change', e=>{
      if(e.target && e.target.id==='p-photo-file'){
        const f=e.target.files[0]; if(!f) return; lastPhotoFile = f;
        const fr=new FileReader(); fr.onload=()=>{ document.getElementById('p-photo').src=fr.result; };
        fr.readAsDataURL(f);
      }
    });

    function getFormPlayer(){
      return {
        firstName:document.getElementById('p-firstname').value.trim(),
        lastName:document.getElementById('p-lastname').value.trim(),
        role:document.getElementById('p-role').value,
        category:normalizeCategory(document.getElementById('p-category').value),
        module:document.getElementById('p-module').value.trim(),
        team:document.getElementById('p-team').value.trim(),
        foot:document.getElementById('p-foot').value,
        year:document.getElementById('p-year').value,
        notes:document.getElementById('p-notes').value,
        photo:document.getElementById('p-photo').src || ''
      };
    }

    function savePlayer(){
      const p = getFormPlayer();
      if(cloud.isOn){ savePlayerCloud(p); }
      else { if(currentIndex!=null){ players[currentIndex]=p; } else { players.push(p); } closeModal(); render(); }
    }
    function editPlayer(i){ openModal((cloud.isOn?cloud.players:players)[i]); }

    // Filtri
    function applyFilters(){
      const name=(document.getElementById('f-name').value||'').toLowerCase();
      const team=(document.getElementById('f-team').value||'').toLowerCase();
      const role=document.getElementById('f-role').value;
      const categorySel=document.getElementById('f-category').value;
      const categoryNorm=normalizeCategory(categorySel);
      const module=document.getElementById('f-module').value;
      const foot=document.getElementById('f-foot').value;
      const src = cloud.isOn ? cloud.players : players;
      const list=src.filter(p=>
        (!name || ((p.lastName||'').toLowerCase().includes(name) || (p.firstName||'').toLowerCase().includes(name))) &&
        (!team || (p.team||'').toLowerCase().includes(team)) &&
        (!role || p.role===role) &&
        (!categoryNorm || normalizeCategory(p.category)===categoryNorm) &&
        (!module || p.module===module) &&
        (!foot || p.foot===foot)
      );
      render(list);
    }
    function resetFilters(){ document.querySelectorAll('.controls input,.controls select').forEach(e=>e.value=''); render(); }

    // Import Excel
    function triggerExcel(){ document.getElementById('excel-file').click(); }
    document.getElementById('excel-file').addEventListener('change', async e=>{
      const file=e.target.files[0]; if(!file) return;
      try{
        const data=await file.arrayBuffer();
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1});
        if(!rows.length){ alert('Il file è vuoto.'); return; }
        const headers=rows[0].map(h=>String(h||'').trim());
        const idx=(names)=>{ const norm=s=>s.toLowerCase().replace(/[^a-z0-9]/g,''); const set=new Set(names.map(norm)); for(let i=0;i<headers.length;i++){ if(set.has(norm(headers[i]))) return i; } return -1; };
        const iNome=idx(['nome','first','firstname','giocatore']);
        const iCogn=idx(['cognome','last','lastname','surname']);
        const iRuolo=idx(['ruolo','role']);
        const iTeam=idx(['squadra','club','team']);
        const iAnno=idx(['anno','annodinascita','birthyear','a.n.','year','nascita']);
        const iCat =idx(['categoria','cat','league','campionato']);
        const iMod =idx(['modulo','sistema','formation','module']);
        const iPiede=idx(['piede','foot']);
        const iNote=idx(['note','osservazioni','commenti']);
        const iFoto=idx(['foto','immagine','image','photo','urlfoto']);
        const toAdd=[];
        for(let r=1;r<rows.length;r++){
          const row=rows[r]||[];
          let firstName=(iNome>=0? String(row[iNome]||'').trim():''), lastName=(iCogn>=0? String(row[iCogn]||'').trim():'');
          if(!lastName && firstName){ const parts=firstName.split(/\s+/); if(parts.length>1){ lastName=parts.pop(); firstName=parts.join(' '); } }
          const role=(iRuolo>=0? String(row[iRuolo]||'').trim():''), team=(iTeam>=0? String(row[iTeam]||'').trim():'');
          let year=(iAnno>=0? Number(String(row[iAnno]).replace(/[^0-9]/g,'')) : '');
          let categoryRaw=(iCat>=0? String(row[iCat]||'').trim():'');
          const module=(iMod>=0? String(row[iMod]||'').trim():''), foot=(iPiede>=0? String(row[iPiede]||'').trim():'');
          const notes=(iNote>=0? String(row[iNote]||'').trim():''), photo=(iFoto>=0? String(row[iFoto]||'').trim():'');
          const category=normalizeCategory(categoryRaw);
          toAdd.push({ firstName,lastName,role:role||'Centrocampista',category,module,team,foot,year,notes,photo });
        }
        if(cloud.isOn){ for(const p of toAdd){ await savePlayerCloud(p,true); } }
        else { players.push(...toAdd); render(); }
        alert(`Importati ${toAdd.length} giocatori.`);
      }catch(err){ console.error(err); alert('Errore durante l\'importazione. Verifica il file.'); }
      finally{ e.target.value=''; }
    });

    // ======= CLOUD LAYER (Firebase) =======
    function openCloudSettings(){
      const m=document.getElementById('cloud-modal');
      const saved = localStorage.getItem('firebaseConfig');
      if(saved){ document.getElementById('firebase-config-input').value=saved; }
      m.classList.add('open');
    }
    function closeCloudSettings(){ document.getElementById('cloud-modal').classList.remove('open'); }

    function connectFirebaseFromUI(){
      const raw = document.getElementById('firebase-config-input').value.trim();
      let cfg=null;
      try{ cfg = raw.startsWith('{') ? JSON.parse(raw) : (0,eval)('('+raw+')'); }
      catch(e){ alert('Configurazione non valida. Incolla il JSON di Firebase.'); return; }
      localStorage.setItem('firebaseConfig', JSON.stringify(cfg));
      closeCloudSettings();
      connectFirebase(cfg);
    }

    async function connectFirebase(cfg){
      try{
        fbApp = firebase.initializeApp(cfg);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        await auth.signInAnonymously();
        uid = auth.currentUser.uid;
        setCloudStatus(true);
        cloud.isOn = true;
        startListener();
      }catch(err){
        console.error(err);
        alert('Connessione Firebase fallita. Controlla config e regole.');
        setCloudStatus(false); cloud.isOn=false;
      }
    }

    function startListener(){
      if(unsub) unsub();
      unsub = db.collection('users').doc(uid).collection('players')
        .orderBy('lastName')
        .onSnapshot(snap=>{
          cloud.players = snap.docs.map(d=>({ __id:d.id, ...d.data() }));
          render(cloud.players);
        });
    }

    async function uploadPhotoIfNeeded(docId){
      if(!lastPhotoFile) return null;
      const ref = storage.ref().child(`users/${uid}/photos/${docId}`);
      await ref.put(lastPhotoFile);
      lastPhotoFile = null;
      return await ref.getDownloadURL();
    }

    async function savePlayerCloud(p, silent=false){
      const col = db.collection('users').doc(uid).collection('players');
      try{
        if(currentIndex!=null && cloud.players[currentIndex]){
          const id = cloud.players[currentIndex].__id;
          const maybeUrl = await uploadPhotoIfNeeded(id);
          const data = { ...p };
          if(maybeUrl) data.photoUrl = maybeUrl;
          await col.doc(id).set(data, { merge:true });
        } else {
          const docRef = await col.add({ ...p });
          const maybeUrl = await uploadPhotoIfNeeded(docRef.id);
          if(maybeUrl){ await docRef.set({ photoUrl: maybeUrl }, { merge:true }); }
        }
        if(!silent){ closeModal(); }
      }catch(err){ console.error(err); alert('Errore salvataggio su Cloud.'); }
    }

    // Auto-connect se è già salvata una config
    (function(){
      const saved = localStorage.getItem('firebaseConfig');
      if(saved){ try{ const cfg=JSON.parse(saved); connectFirebase(cfg); }catch(e){} }
      else{ setCloudStatus(false); }
    })();
  </script>
</body>
</html>
